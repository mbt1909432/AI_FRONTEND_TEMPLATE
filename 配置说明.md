# 🚀 Chat-to-Agent 项目 CI/CD 配置说明

## 📋 项目分析结果

你的项目是一个**纯前端 React 应用**，具有以下特点：

- **框架**: React 18.2.0
- **构建工具**: react-scripts (Create React App)
- **部署方式**: Docker (Node.js 构建 + Nginx 服务)
- **端口**: 1923
- **镜像仓库**: GitHub Container Registry (GHCR)

## ✅ 已完成的修改

### 1. GitHub Actions Workflow

**文件**: `.github/workflows/action_for_deployment.yml`

**主要改动**:
```yaml
- 移除了不存在的 backend 构建
- 移除了 deployment 文件夹依赖
- 简化为单一前端应用部署流程
- 添加手动触发功能
- 使用 GHCR 作为镜像仓库
- 自动清理旧镜像
```

**工作流程**:
1. 代码检出
2. 配置 SSH 密钥
3. 登录 GHCR
4. 构建并推送 Docker 镜像
5. SSH 连接服务器部署
6. 自动清理旧镜像

### 2. Docker 配置文件

#### `docker-compose.yml` (已修改)
```yaml
# 从本地构建改为使用 GHCR 镜像
image: ghcr.io/${GIT_USER}/chat-to-agent:latest
```

#### `docker-compose.prod.yml` (新增)
```yaml
# 生产环境优化配置
- 健康检查
- 日志轮转
- 自动重启
```

### 3. 新增文档

| 文档 | 用途 |
|------|------|
| `DEPLOYMENT_GUIDE.md` | 完整的部署指南（20+ 页） |
| `DEPLOYMENT_CHECKLIST.md` | 快速配置清单 |
| `DEPLOYMENT_SUMMARY.md` | 配置总结 |
| `配置说明.md` | 本文件 - 中文配置说明 |

### 4. 新增脚本

| 脚本 | 用途 |
|------|------|
| `server-setup.sh` | 服务器自动配置脚本 |
| `local-test.sh` | 本地 Docker 测试脚本 |

### 5. 更新现有文档

- ✅ `README.md` - 添加 CI/CD 部署说明

## 🔧 配置步骤

### 步骤 1: 配置 GitHub Secrets

进入: `GitHub 仓库` → `Settings` → `Secrets and variables` → `Actions`

需要配置 4 个 Secrets:

| Secret 名称 | 说明 | 如何获取 |
|-------------|------|----------|
| `GIT_USER` | GitHub 用户名 | 你的用户名 |
| `GIT_TOKEN` | GitHub Token | [创建 Token](#创建-github-token) |
| `HOST_NAME` | 服务器地址 | 服务器 IP 或域名 |
| `DEPLOY_SSH_KEY` | SSH 私钥 | [生成 SSH 密钥](#生成-ssh-密钥) |

#### 创建 GitHub Token

1. 访问: https://github.com/settings/tokens
2. 点击 **"Generate new token"** → **"Generate new token (classic)"**
3. 设置名称: `chat-to-agent-deploy`
4. 选择权限:
   - ✅ `write:packages` - 推送镜像
   - ✅ `read:packages` - 拉取镜像
   - ✅ `delete:packages` - 删除旧镜像（可选）
5. 点击 **"Generate token"**
6. **复制 Token**（只显示一次！）

#### 生成 SSH 密钥

**在本地电脑运行**:

```bash
# 生成 ED25519 密钥（更安全）
ssh-keygen -t ed25519 -C "github-actions-deploy" -f ~/.ssh/deploy_key

# 查看私钥（复制到 GitHub Secret: DEPLOY_SSH_KEY）
cat ~/.ssh/deploy_key

# 查看公钥（添加到服务器）
cat ~/.ssh/deploy_key.pub
```

**私钥格式示例**:
```
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
...
-----END OPENSSH PRIVATE KEY-----
```

### 步骤 2: 配置服务器

#### 方式 A: 使用自动配置脚本（推荐）

**将脚本上传到服务器**:
```bash
# 在本地
scp server-setup.sh root@your-server-ip:~
```

**在服务器上运行**:
```bash
ssh root@your-server-ip
chmod +x server-setup.sh
./server-setup.sh
```

脚本会自动完成:
- ✅ 更新系统
- ✅ 安装 Docker
- ✅ 配置防火墙
- ✅ 创建工作目录
- ✅ 配置环境变量
- ✅ 登录 GHCR

#### 方式 B: 手动配置

**1. 添加 SSH 公钥到服务器**:
```bash
# SSH 登录服务器
ssh root@your-server-ip

# 添加公钥
mkdir -p ~/.ssh
echo "你的公钥内容" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh
```

**2. 安装 Docker**:
```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com | sh
systemctl start docker
systemctl enable docker

# 验证安装
docker --version
docker compose version
```

**3. 配置环境变量**:
```bash
# 创建工作目录
mkdir -p ~/chat-to-agent
cd ~/chat-to-agent

# 设置 GIT_USER（重要！）
export GIT_USER=你的GitHub用户名
echo "export GIT_USER=你的GitHub用户名" >> ~/.bashrc
source ~/.bashrc
```

**4. 登录 GHCR**:
```bash
echo YOUR_GITHUB_TOKEN | docker login ghcr.io -u YOUR_USERNAME --password-stdin
```

**5. 配置防火墙**:
```bash
# 开放必要端口
ufw allow 22/tcp    # SSH
ufw allow 1923/tcp  # 应用端口
ufw enable
```

### 步骤 3: 修改代码（重要！）

**修改 `docker-compose.yml`**:

找到这一行:
```yaml
image: ghcr.io/${GIT_USER:-your-github-username}/chat-to-agent:latest
```

将 `your-github-username` 改为你的**实际 GitHub 用户名**，例如:
```yaml
image: ghcr.io/${GIT_USER:-zhangsan}/chat-to-agent:latest
```

> 💡 **提示**: 使用环境变量 `${GIT_USER}` 可以避免硬编码

### 步骤 4: 提交并推送代码

```bash
git add .
git commit -m "chore: setup CI/CD deployment"
git push origin main
```

### 步骤 5: 查看部署状态

#### 在 GitHub 上:
1. 进入仓库
2. 点击 **"Actions"** 标签
3. 查看最新的 workflow 运行状态
4. 点击查看详细日志

#### 在服务器上:
```bash
# 查看容器状态
docker ps | grep chat-to-agent

# 查看日志
docker logs -f chat-to-agent

# 测试访问
curl http://localhost:1923
```

### 步骤 6: 访问应用

在浏览器中访问:
```
http://your-server-ip:1923
```

## 🧪 本地测试（可选）

在推送到 GitHub 前，可以先在本地测试:

```bash
chmod +x local-test.sh
./local-test.sh
```

脚本会:
- 构建 Docker 镜像
- 启动测试容器
- 测试服务连接
- 提供访问地址

测试成功后访问: http://localhost:1923

## 📊 部署架构图

```
┌──────────────────────────────────────────────────────────────┐
│                         开发者                                 │
└───────────────────────┬──────────────────────────────────────┘
                        │ git push
                        ▼
┌──────────────────────────────────────────────────────────────┐
│                     GitHub Actions                            │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐             │
│  │ Checkout   │→ │   Build    │→ │  Push to   │             │
│  │   Code     │  │   Docker   │  │    GHCR    │             │
│  └────────────┘  └────────────┘  └────────────┘             │
└───────────────────────┬──────────────────────────────────────┘
                        │ SSH Deploy
                        ▼
┌──────────────────────────────────────────────────────────────┐
│                        服务器                                  │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐             │
│  │   Pull     │→ │  Docker    │→ │  Service   │             │
│  │   Image    │  │  Compose   │  │   Live     │             │
│  └────────────┘  └────────────┘  └────────────┘             │
│                                         ▼                     │
│                                   Port: 1923                  │
└──────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌──────────────────────────────────────────────────────────────┐
│                        用户访问                                │
│                http://server-ip:1923                          │
└──────────────────────────────────────────────────────────────┘
```

## 🔍 常见问题

### Q1: GitHub Actions 构建失败

**检查**:
- ✅ GitHub Secrets 配置是否正确
- ✅ Token 权限是否包含 `write:packages`
- ✅ SSH 密钥格式是否正确（包含头尾）

**解决方案**:
```bash
# 查看 Actions 日志
GitHub → Actions → 点击失败的 workflow → 查看错误信息
```

### Q2: SSH 连接失败

**原因**:
- SSH 密钥未添加到服务器
- 服务器 SSH 端口被防火墙阻止
- known_hosts 问题

**解决方案**:
```bash
# 测试 SSH 连接
ssh -i ~/.ssh/deploy_key root@your-server-ip

# 检查服务器 SSH 配置
cat /etc/ssh/sshd_config | grep PubkeyAuthentication
# 应该是: PubkeyAuthentication yes

# 重启 SSH 服务
systemctl restart sshd
```

### Q3: 镜像拉取失败

**原因**:
- 未登录 GHCR
- 镜像名称错误
- Token 权限不足

**解决方案**:
```bash
# 在服务器上手动登录
echo YOUR_TOKEN | docker login ghcr.io -u YOUR_USERNAME --password-stdin

# 检查镜像是否存在
# 访问: https://github.com/YOUR_USERNAME?tab=packages

# 手动拉取测试
docker pull ghcr.io/YOUR_USERNAME/chat-to-agent:latest
```

### Q4: 容器启动失败

**检查**:
```bash
# 查看详细日志
docker logs chat-to-agent

# 查看容器状态
docker inspect chat-to-agent

# 检查端口占用
netstat -tlnp | grep 1923
```

### Q5: 访问不了应用

**检查清单**:
- ✅ 容器是否运行: `docker ps`
- ✅ 端口是否开放: `netstat -tlnp | grep 1923`
- ✅ 防火墙是否允许: `ufw status`
- ✅ 服务器 IP 是否正确

**测试**:
```bash
# 在服务器上测试
curl http://localhost:1923

# 检查 Nginx 日志
docker logs chat-to-agent | grep error
```

## 🔄 日常使用

### 更新应用

**方式 1: 自动部署（推荐）**
```bash
git add .
git commit -m "feat: new feature"
git push origin main
# GitHub Actions 会自动部署
```

**方式 2: 手动触发**
```
GitHub → Actions → action_for_deployment.yml → Run workflow
```

### 查看日志

```bash
# 实时日志
docker logs -f chat-to-agent

# 最近 100 行
docker logs --tail 100 chat-to-agent

# 带时间戳
docker logs -t chat-to-agent
```

### 重启服务

```bash
# 方式 1: 重启容器
docker restart chat-to-agent

# 方式 2: 使用 compose
cd ~/chat-to-agent
docker compose restart

# 方式 3: 重新部署
docker compose down
docker compose pull
docker compose up -d
```

### 回滚版本

```bash
# 查看可用的镜像版本
# 访问: https://github.com/YOUR_USERNAME?tab=packages

# 拉取特定版本（使用 commit SHA）
docker pull ghcr.io/YOUR_USERNAME/chat-to-agent:COMMIT_SHA

# 修改 docker-compose.yml
# image: ghcr.io/YOUR_USERNAME/chat-to-agent:COMMIT_SHA

# 重新部署
docker compose up -d
```

## 📈 监控和优化

### 资源监控

```bash
# 实时资源使用
docker stats chat-to-agent

# 查看磁盘使用
docker system df

# 查看镜像大小
docker images | grep chat-to-agent
```

### 日志管理

```bash
# 查看日志文件位置
docker inspect chat-to-agent | grep LogPath

# 清理日志（重启容器）
docker compose restart
```

### 性能优化

**1. 启用 Gzip 压缩** (已在 nginx.conf 配置)
```nginx
gzip on;
gzip_types text/plain text/css application/json application/javascript;
```

**2. 配置缓存** (已在 nginx.conf 配置)
```nginx
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

**3. 使用 CDN** (可选)
- Cloudflare
- AWS CloudFront
- 阿里云 CDN

## 🌐 域名配置（可选）

### 配置 Nginx 反向代理

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://localhost:1923;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 配置 HTTPS

```bash
# 安装 Certbot
apt install certbot python3-certbot-nginx

# 获取证书
certbot --nginx -d your-domain.com

# 自动续期
certbot renew --dry-run
```

## 📚 相关文档

- 📋 [DEPLOYMENT_GUIDE.md](./DEPLOYMENT_GUIDE.md) - 详细部署指南（英文）
- ✅ [DEPLOYMENT_CHECKLIST.md](./DEPLOYMENT_CHECKLIST.md) - 快速配置清单
- 📊 [DEPLOYMENT_SUMMARY.md](./DEPLOYMENT_SUMMARY.md) - 配置总结
- 🐳 [DOCKER.md](./DOCKER.md) - Docker 部署说明
- 📖 [README.md](./README.md) - 项目介绍

## 💡 最佳实践

1. **安全**:
   - ✅ 使用强密码
   - ✅ 定期更新 Token
   - ✅ 不要将私钥提交到仓库
   - ✅ 配置防火墙规则

2. **备份**:
   - ✅ 备份 docker-compose.yml
   - ✅ 备份环境变量配置
   - ✅ 定期导出 Docker 镜像

3. **监控**:
   - ✅ 定期检查日志
   - ✅ 监控资源使用
   - ✅ 设置告警通知

4. **更新**:
   - ✅ 定期更新系统
   - ✅ 定期更新 Docker
   - ✅ 及时更新依赖包

## 🆘 获取帮助

如果遇到问题:

1. **查看日志**:
   ```bash
   # GitHub Actions 日志
   GitHub → Actions → 查看失败的步骤
   
   # Docker 日志
   docker logs chat-to-agent
   
   # 系统日志
   tail -f /var/log/syslog
   ```

2. **检查配置**:
   - GitHub Secrets 是否正确
   - 服务器环境是否配置完整
   - 网络连接是否正常

3. **常用调试命令**:
   ```bash
   # 测试 SSH
   ssh -vvv root@your-server-ip
   
   # 测试 Docker
   docker run hello-world
   
   # 测试网络
   curl -I http://localhost:1923
   
   # 查看进程
   ps aux | grep docker
   ```

## 🎉 完成！

配置完成后，你的应用将实现:
- ✅ 自动化 CI/CD 部署
- ✅ Git Push 即部署
- ✅ 零停机更新
- ✅ 自动健康检查
- ✅ 日志管理
- ✅ 容器化部署

---

**祝你部署顺利！如有问题，请查阅相关文档或提交 Issue。** 🚀

