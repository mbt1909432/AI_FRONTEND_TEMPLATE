# ⚡ 快速开始 - CI/CD 部署配置

> 5 分钟完成 Chat-to-Agent 项目的自动化部署配置

## 📝 配置前准备

你需要准备:
- ✅ GitHub 账号
- ✅ 一台服务器（VPS）
- ✅ 服务器 root 权限
- ✅ 10 分钟时间

## 🚀 三步配置

### 第一步: 配置 GitHub Secrets (3 分钟)

#### 1.1 创建 GitHub Token

访问: https://github.com/settings/tokens

1. 点击 **Generate new token (classic)**
2. 名称: `chat-to-agent-deploy`
3. 勾选权限:
   - ✅ `write:packages`
   - ✅ `read:packages`
4. 点击 **Generate token**
5. **复制 Token**（只显示一次！）

#### 1.2 生成 SSH 密钥

在**本地电脑**运行:

```bash
ssh-keygen -t ed25519 -C "deploy" -f ~/.ssh/deploy_key
```

按 3 次回车（不设置密码）

查看密钥:
```bash
# 私钥（准备复制）
cat ~/.ssh/deploy_key

# 公钥（准备复制）
cat ~/.ssh/deploy_key.pub
```

#### 1.3 添加 Secrets 到 GitHub

进入你的仓库: `Settings` → `Secrets and variables` → `Actions`

点击 **New repository secret**，添加以下 4 个:

| 名称 | 值 |
|------|---|
| `GIT_USER` | 你的 GitHub 用户名 |
| `GIT_TOKEN` | 刚才创建的 Token |
| `HOST_NAME` | 服务器 IP 地址 |
| `DEPLOY_SSH_KEY` | 私钥内容（整个文件） |

### 第二步: 配置服务器 (2 分钟)

#### 2.1 上传配置脚本

```bash
# 在本地运行
scp server-setup.sh root@你的服务器IP:~
```

#### 2.2 运行配置脚本

```bash
# SSH 登录服务器
ssh root@你的服务器IP

# 运行脚本
chmod +x server-setup.sh
./server-setup.sh
```

脚本会自动:
- 安装 Docker
- 配置防火墙
- 创建工作目录
- 登录 GHCR

按照提示输入:
1. 你的 GitHub 用户名
2. 你的 GitHub Token

#### 2.3 添加 SSH 公钥

还在服务器上，运行:

```bash
# 粘贴你本地的公钥内容
echo "你的公钥内容" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

### 第三步: 推送代码 (1 分钟)

#### 3.1 修改配置

编辑 `docker-compose.yml`，找到:

```yaml
image: ghcr.io/${GIT_USER:-your-github-username}/chat-to-agent:latest
```

将 `your-github-username` 改为你的 GitHub 用户名。

#### 3.2 提交并推送

```bash
git add .
git commit -m "chore: setup CI/CD"
git push origin main
```

#### 3.3 查看部署进度

1. 打开 GitHub 仓库
2. 点击 **Actions** 标签
3. 看到绿色 ✅ 表示部署成功！

#### 3.4 访问应用

在浏览器访问:
```
http://你的服务器IP:1923
```

## ✅ 完成！

现在，每次你推送代码到 `main` 分支，应用都会自动部署！

## 🔍 验证部署

### 在服务器上检查

```bash
# 查看容器状态
docker ps | grep chat-to-agent

# 查看日志
docker logs -f chat-to-agent
```

### 测试连接

```bash
# 在服务器上
curl http://localhost:1923

# 在本地
curl http://你的服务器IP:1923
```

## 📊 部署流程

```
推送代码 → GitHub Actions 自动构建 → 推送镜像到 GHCR → SSH 部署到服务器 → 应用上线
```

每次部署大约需要 **2-5 分钟**。

## 🎯 下次更新应用

非常简单:

```bash
# 修改代码
vim src/App.js

# 提交推送
git add .
git commit -m "feat: new feature"
git push origin main

# 自动部署！无需任何操作
```

## 🛠️ 常用命令

### 服务器管理

```bash
# 查看容器
docker ps

# 查看日志
docker logs -f chat-to-agent

# 重启服务
docker restart chat-to-agent

# 更新服务
cd ~/chat-to-agent
docker compose pull
docker compose up -d
```

### 本地测试

```bash
# 在推送前测试
chmod +x local-test.sh
./local-test.sh

# 访问测试
http://localhost:1923
```

## ❓ 遇到问题？

### GitHub Actions 失败

查看:
```
GitHub → Actions → 点击失败的任务 → 查看日志
```

常见原因:
- Secrets 配置错误
- Token 权限不足
- SSH 密钥错误

### 无法访问应用

检查:
```bash
# 容器是否运行
docker ps | grep chat-to-agent

# 端口是否开放
ufw status

# 防火墙允许 1923 端口
ufw allow 1923/tcp
```

### SSH 连接失败

测试:
```bash
# 本地测试 SSH
ssh -i ~/.ssh/deploy_key root@你的服务器IP

# 如果失败，检查:
# 1. 公钥是否添加到服务器
# 2. 权限是否正确 (600)
# 3. 服务器 SSH 服务是否运行
```

## 📚 更多文档

详细配置请查看:
- 📋 [配置说明.md](./配置说明.md) - 完整中文配置指南
- 📖 [DEPLOYMENT_GUIDE.md](./DEPLOYMENT_GUIDE.md) - 英文详细指南
- ✅ [DEPLOYMENT_CHECKLIST.md](./DEPLOYMENT_CHECKLIST.md) - 配置清单

## 💡 提示

1. **首次部署**可能需要 3-5 分钟构建镜像
2. **后续部署**有缓存，只需 1-2 分钟
3. 推荐配置**域名和 HTTPS**提升体验
4. 定期**备份** docker-compose.yml 配置

## 🎉 完成

恭喜！你已经成功配置了 CI/CD 自动部署。

现在你可以:
- ✅ 专注开发，推送即部署
- ✅ 版本自动管理
- ✅ 零停机更新
- ✅ 一键回滚

---

**Happy Coding! 🚀**

有问题随时查阅文档或提交 Issue。

